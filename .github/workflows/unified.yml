name: unified

on:
  workflow_dispatch:
  schedule:
    - cron: "35 5 * * 1-5"  # weekdays 06:35 CET approx

jobs:
  unified:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install pandas yfinance requests beautifulsoup4

      - name: Build Milan universe (>=50, EUR, Tech/USA/Thematics)
        run: |
          python etf-trading-engine/scripts/build_universe_milano.py

      - name: Fetch EOD data from Yahoo Finance
        run: |
          python etf-trading-engine/scripts/download_eod_yf.py

      - name: Compiling latest snapshot
        run: |
          python - <<'PY'
          import os, json, glob
          # Example: compile a lightweight snapshot artifact
          files = sorted(glob.glob("data/eod/*.csv"))
          result = {"files": len(files)}
          print(json.dumps(result))
          PY

      - name: Prepare EOD for model (fix dtypes)
        run: echo "placeholder"

      - name: Run model
        run: echo "placeholder"

      - name: System checks (auto QA)
        run: echo "placeholder"

      - name: Persist full dataset to repository
        if: ${{ always() }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git add -A || true
          git commit -m "ci: update EOD snapshot [skip ci]" || true
          git push || true

      - name: Post Setup Python
        run: python -c "print('done')"
