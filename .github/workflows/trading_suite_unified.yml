name: Trading Suite — Unified (Fetch→Index→Model→Report)

on:
  workflow_dispatch:
  schedule:
    - cron: "45 15 * * 1-5"   # feriali ~17:45 Europe/Rome

permissions:
  contents: write

jobs:
  unified:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout suite
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance pandas-datareader pyyaml

      - name: Extend & fetch data (robust)
        run: |
          python scripts/fetch_and_index_v2.py \
            --universe etf-trading-config/universe.csv \
            --data-root data \
            --latest-dir latest \
            --min 220 \
            --tolerance 0.8

      - name: Prepare EOD for model (fix dtypes)
        run: |
          python scripts/fix_eod_types.py \
            --snapshot latest/eod-latest.csv \
            --output   etf-trading-engine/data/eod.csv

      - name: Run model
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/src:${{ github.workspace }}/etf-trading-engine:${{ github.workspace }}/etf-trading-engine/src
        run: |
          mkdir -p outputs
          python etf-trading-engine/scripts/run_ci_backtest.py \
            --config ./etf-trading-config/model.yaml \
            --data   ./etf-trading-engine/data/eod.csv \
            --outdir ./outputs

      - name: System checks (auto QA)
        run: |
          python scripts/system_checks.py \
            --index latest/index.json \
            --eod latest/eod-latest.csv \
            --report outputs

      - name: Persist latest results to repo
        run: |
         mkdir -p latest
         cp -r latest/*.csv latest/*.json latest/*.txt ./ || true
         git config --global user.name "github-actions[bot]"
         git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
         git add latest/*.csv latest/*.json latest/*.txt || true
         git commit -m "Update latest dataset and index [auto]" || echo "No changes to commit"
         git push origin main || echo "Push skipped (already up to date)"

