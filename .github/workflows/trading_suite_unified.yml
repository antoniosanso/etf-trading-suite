name: Trading Suite ‚Äî Unified (Fetch‚ÜíIndex‚ÜíModel‚ÜíReport‚ÜíPersist)

on:
  workflow_dispatch:
  schedule:
    - cron: "45 15 * * 1-5"

permissions:
  contents: write

jobs:
  unified:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout suite
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance pandas-datareader pyyaml

      - name: üîÑ Sync ETF Universe
        run: |
          echo "Fetching latest ETF universe..."
          curl -L -o etf-trading-config/universe.csv \
          https://raw.githubusercontent.com/antoniosanso/etf-trading-suite/main/etf-trading-config/universe.csv
          head -n 5 etf-trading-config/universe.csv

      - name: Extend & fetch data (robust)
        run: |
          python scripts/fetch_and_index_v2.py \
            --universe etf-trading-config/universe.csv \
            --data-root data \
            --latest-dir latest \
            --min 220 \
            --tolerance 0.8

      - name: Prepare EOD for model (fix dtypes)
        run: |
          python scripts/fix_eod_types.py \
            --snapshot latest/eod-latest.csv \
            --output   etf-trading-engine/data/eod.csv

      - name: Run model
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/src:${{ github.workspace }}/etf-trading-engine:${{ github.workspace }}/etf-trading-engine/src
        run: |
          mkdir -p outputs
          python etf-trading-engine/scripts/run_ci_backtest.py \
            --config ./etf-trading-config/model.yaml \
            --data   ./etf-trading-engine/data/eod.csv \
            --outdir ./outputs

      - name: System checks (auto QA)
        run: |
          python scripts/system_checks.py \
            --index latest/index.json \
            --eod latest/eod-latest.csv \
            --report outputs

      - name: Persist full dataset to repository
        run: |
          echo "üì¶ Preparing to persist full dataset..."
          mkdir -p latest data
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Assicurati che esistano i file prima del commit
          ls -lh latest/ || true
          ls -lh data/ || true

          # Aggiungi sia latest che data (storico)
          git add latest/*.csv latest/*.json latest/*.txt data/*.csv || true

          # Commit solo se ci sono modifiche
          git diff --cached --quiet || git commit -m "Auto-update: persist full dataset (latest + data)"

          # Push verso main
          git push origin main || echo "‚ö†Ô∏è Nothing new to push (already up-to-date)"
